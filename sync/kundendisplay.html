<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Kundendisplay – Sandersdorfer Karnevalsverein e.V.</title>
    <style>
        :root {
            --bg: #0f172a;
            --royal-blue: #4169E1;
            --panel-bg: #ffffff;
            --muted: #64748b;
            --accent: #f97316;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "Segoe UI", system-ui, sans-serif;
            background: radial-gradient(circle at top, rgba(65,105,225,0.12), rgba(15,23,42,0.95));
            color: #0f172a;
            display: flex;
            justify-content: center;
        }

        .display-app {
            min-height: 100vh;
            width: min(1100px, 96vw);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 32px;
            padding: 48px 24px 64px;
        }

        .display-header {
            text-align: center;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 18px;
        }

        .display-logo {
            width: clamp(160px, 24vw, 220px);
            height: clamp(160px, 24vw, 220px);
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 0 18px 50px rgba(15, 23, 42, 0.45);
            background: #fff;
            padding: 12px;
        }

        .display-header h1 {
            margin: 0;
            font-size: clamp(26px, 5vw, 38px);
            letter-spacing: 1px;
            text-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
        }

        .display-main {
            width: 100%;
            display: flex;
            justify-content: center;
        }

        .display-main[hidden] {
            display: none;
        }

        .invoice-view {
            width: min(900px, 100%);
        }

        .invoice-card {
            background: var(--panel-bg);
            border-radius: 28px;
            padding: clamp(24px, 4vw, 36px);
            box-shadow: 0 30px 80px rgba(15, 23, 42, 0.35);
            display: flex;
            flex-direction: column;
            gap: 28px;
        }

        .invoice-card__header h2 {
            margin: 0;
            font-size: clamp(22px, 3vw, 30px);
            color: var(--royal-blue);
        }

        .invoice-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px 24px;
            font-size: 15px;
            color: var(--muted);
        }

        .invoice-meta strong {
            color: #0f172a;
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
        }

        .invoice-table thead th {
            text-align: left;
            font-weight: 600;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(65, 105, 225, 0.2);
            font-size: 14px;
            color: var(--muted);
        }

        .invoice-table tbody td {
            padding: 12px 0;
            border-bottom: 1px solid rgba(148, 163, 184, 0.25);
        }

        .invoice-table tbody tr:last-child td {
            border-bottom: 0;
        }

        .invoice-line-name {
            font-weight: 600;
            color: #0f172a;
        }

        .invoice-line-detail {
            color: var(--muted);
            font-size: 13px;
        }

        .invoice-summary {
            display: flex;
            justify-content: space-between;
            gap: 24px;
            align-items: center;
            flex-wrap: wrap;
        }

        .invoice-total {
            font-size: clamp(24px, 4vw, 32px);
            font-weight: 700;
            color: #0f172a;
        }

        .invoice-payment {
            font-size: 16px;
            color: var(--muted);
        }

        .invoice-note {
            margin: 0;
            font-size: 13px;
            color: var(--muted);
        }

        .invoice-thankyou {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 12px 0 4px;
        }

        .invoice-thankyou h2 {
            margin: 0;
            font-size: clamp(48px, 8vw, 72px);
            letter-spacing: 1.5px;
            color: var(--royal-blue);
        }

        .invoice-qr {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .invoice-qr[hidden] {
            display: none;
        }

        .invoice-qr img {
            width: clamp(220px, 32vw, 300px);
            height: clamp(220px, 32vw, 300px);
            border-radius: 18px;
            box-shadow: 0 24px 50px rgba(15, 23, 42, 0.28);
            background: #fff;
            object-fit: cover;
        }

        .invoice-qr-note {
            margin: 0;
            font-size: 16px;
            color: var(--muted);
        }

        .invoice-thankyou-total,
        .invoice-thankyou-payment {
            margin: 0;
            font-size: 18px;
            color: #0f172a;
        }

        .invoice-thankyou-payment {
            font-size: 16px;
            color: var(--muted);
        }
    </style>
</head>
<body>
<div class="display-app">
    <header class="display-header">
        <img src="../img/SKV-Wappen.jpg" alt="Logo des Sandersdorfer Karnevalsverein" class="display-logo" />
        <h1 id="display-title">Herzlich willkommen beim Sandersdorfer Karnevalsverein</h1>
    </header>
    <main id="display-main" class="display-main" hidden>
        <section class="invoice-view">
            <article class="invoice-card">
                <div id="cart-content">
                    <header class="invoice-card__header">
                        <h2 id="invoice-title">Rechnungsübersicht</h2>
                        <div class="invoice-meta" id="invoice-meta"></div>
                    </header>
                    <div class="invoice-content" id="invoice-content">
                        <table class="invoice-table" aria-describedby="invoice-title">
                            <thead>
                            <tr>
                                <th scope="col">Position</th>
                                <th scope="col" style="width:100px; text-align:right;">Karten</th>
                                <th scope="col" style="width:140px; text-align:right;">Einzelpreis</th>
                                <th scope="col" style="width:160px; text-align:right;">Gesamt</th>
                            </tr>
                            </thead>
                            <tbody id="invoice-lines"></tbody>
                        </table>
                    </div>
                    <div class="invoice-summary">
                        <div>
                            <div class="invoice-total" id="invoice-total">&mdash;</div>
                            <div class="invoice-payment" id="invoice-payment">&nbsp;</div>
                            <p class="invoice-note">Die Rechnung gilt nicht als Eintrittskarte.</p>
                        </div>
                    </div>
                </div>
                <div id="thankyou-content" class="invoice-thankyou" hidden>
                    <h2 id="thankyou-title">DANKE!</h2>
                    <div class="invoice-qr" id="invoice-qr" hidden>
                        <img id="invoice-qr-image" src="" alt="QR-Code zum Rechnungsdownload" />
                        <p class="invoice-qr-note" id="thankyou-note">(Rechnung)</p>
                    </div>
                    <p class="invoice-thankyou-total" id="thankyou-total" hidden></p>
                    <p class="invoice-thankyou-payment" id="thankyou-payment" hidden></p>
                </div>
            </article>
        </section>
    </main>
</div>
<script>
    const CHANNEL_NAME = "skv-customer-display";
    const STORAGE_KEY = "skv-customer-display-message";
    const MESSAGE_MARKER = "__skvCustomerDisplay";
    const euroFormatter = new Intl.NumberFormat('de-DE', {
        style: 'currency',
        currency: 'EUR',
        minimumFractionDigits: 2,
    });

    const displayTitle = document.getElementById('display-title');
    const displayMain = document.getElementById('display-main');
    const cartContent = document.getElementById('cart-content');
    const thankyouContent = document.getElementById('thankyou-content');
    const invoiceMeta = document.getElementById('invoice-meta');
    const invoiceLines = document.getElementById('invoice-lines');
    const invoiceTotal = document.getElementById('invoice-total');
    const invoicePayment = document.getElementById('invoice-payment');
    const invoiceQr = document.getElementById('invoice-qr');
    const invoiceQrImage = document.getElementById('invoice-qr-image');
    const thankyouTotal = document.getElementById('thankyou-total');
    const thankyouPayment = document.getElementById('thankyou-payment');
    const thankyouNote = document.getElementById('thankyou-note');

    let channel = null;
    let storageListenerBound = false;

    function ensureChannel() {
        if (typeof BroadcastChannel !== 'undefined') {
            if (!channel) {
                channel = new BroadcastChannel(CHANNEL_NAME);
                channel.addEventListener('message', onChannelMessage);
            }
        }
        if (!storageListenerBound && typeof window !== 'undefined') {
            window.addEventListener('storage', onStorageMessage);
            storageListenerBound = true;
        }
    }

    function handleEnvelope(envelope) {
        if (!envelope || envelope.marker !== MESSAGE_MARKER) return;
        const data = envelope.data;
        if (data?.type === 'state' && data.payload) {
            applyState(data.payload);
        }
    }

    function onChannelMessage(event) {
        handleEnvelope(event?.data);
    }

    function onStorageMessage(event) {
        if (!event || event.key !== STORAGE_KEY || !event.newValue) return;
        try {
            const parsed = JSON.parse(event.newValue);
            handleEnvelope(parsed);
        } catch (err) {
            console.warn('[KUNDENDISPLAY] Nachricht aus localStorage konnte nicht gelesen werden:', err);
        }
    }

    function setMode(mode) {
        if (mode === 'welcome') {
            displayTitle.textContent = 'Herzlich willkommen beim Sandersdorfer Karnevalsverein';
            displayMain.hidden = true;
            cartContent.hidden = true;
            thankyouContent.hidden = true;
        } else if (mode === 'cart') {
            displayTitle.textContent = 'Rechnungsübersicht';
            displayMain.hidden = false;
            cartContent.hidden = false;
            thankyouContent.hidden = true;
        } else if (mode === 'invoice') {
            displayTitle.textContent = 'Sandersdorfer Karnevalsverein';
            displayMain.hidden = false;
            cartContent.hidden = true;
            thankyouContent.hidden = false;
        } else {
            displayTitle.textContent = 'Sandersdorfer Karnevalsverein';
            displayMain.hidden = true;
            cartContent.hidden = true;
            thankyouContent.hidden = true;
        }
    }

    function renderCart(cart) {
        invoiceMeta.innerHTML = '';
        invoiceLines.innerHTML = '';
        invoiceTotal.textContent = cart ? euroFormatter.format(cart.totalAmount || 0) : '—';
        invoicePayment.textContent = cart ? `${cart.totalCards || 0} Karten insgesamt` : '\u00a0';
        invoiceQr.hidden = true;
        invoiceQrImage.src = '';
        thankyouTotal.hidden = true;
        thankyouPayment.hidden = true;
        if (!cart || !Array.isArray(cart.lines) || cart.lines.length === 0) {
            invoiceLines.innerHTML = '<tr><td colspan="4">Keine Positionen vorhanden.</td></tr>';
            return;
        }
        for (const line of cart.lines) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <div class="invoice-line-name">${line.name || 'Position'}</div>
                    ${line.detail ? `<div class="invoice-line-detail">${line.detail}</div>` : ''}
                </td>
                <td style="text-align:right; font-weight:600;">${line.quantity}</td>
                <td style="text-align:right;">${line.unitPriceFormatted || ''}</td>
                <td style="text-align:right; font-weight:600;">${line.totalFormatted || ''}</td>
            `;
            invoiceLines.appendChild(tr);
        }
    }

    function renderInvoice(invoice) {
        invoiceMeta.innerHTML = '';
        if (invoice.invoiceNumber || invoice.createdAt) {
            const parts = [];
            if (invoice.invoiceNumber) parts.push(`<strong>Rechnungsnummer:</strong> ${invoice.invoiceNumber}`);
            if (invoice.createdAt) {
                const date = new Date(invoice.createdAt);
                if (!Number.isNaN(date.valueOf())) {
                    parts.push(`<strong>Datum:</strong> ${date.toLocaleDateString('de-DE')} ${date.toLocaleTimeString('de-DE', {
                        hour: '2-digit', minute: '2-digit'
                    })}`);
                }
            }
            invoiceMeta.innerHTML = parts.join('<span aria-hidden="true">•</span>');
        }
        renderCart(invoice);
        const totalAmount = Number.isFinite(invoice.totalAmount) ? invoice.totalAmount : null;
        invoiceTotal.textContent = euroFormatter.format(totalAmount ?? 0);
        const paymentLabel = invoice.paymentLabel ? `Zahlart: ${invoice.paymentLabel}` : '';
        if (totalAmount != null) {
            thankyouTotal.textContent = `Gesamtbetrag: ${euroFormatter.format(totalAmount)}`;
            thankyouTotal.hidden = false;
        } else {
            thankyouTotal.hidden = true;
        }
        thankyouPayment.textContent = paymentLabel;
        thankyouPayment.hidden = !paymentLabel;
        thankyouNote.textContent = '(Rechnung)';
        if (invoice.shareUrl || invoice.shareToken) {
            const href = invoice.shareUrl || buildShareUrl(invoice.shareToken);
            invoiceQr.hidden = false;
            invoiceQrImage.src = buildQrSrc(href);
            invoiceQrImage.alt = 'QR-Code zur Rechnung';
            invoiceQrImage.onerror = () => {
                invoiceQrImage.alt = 'QR-Code konnte nicht geladen werden';
            };
        } else {
            invoiceQr.hidden = true;
            invoiceQrImage.src = '';
        }
    }

    function buildShareUrl(token) {
        const base = new URL(window.location.href);
        base.hash = '';
        base.search = '';
        base.pathname = base.pathname.replace(/[^/]+$/, 'invoice.html');
        return `${base.href.replace(/#.*$/, '')}#${token}`;
    }

    function buildQrSrc(url) {
        const base = 'https://api.qrserver.com/v1/create-qr-code/';
        const params = new URLSearchParams({
            size: '320x320',
            data: url,
        });
        return `${base}?${params.toString()}`;
    }

    function applyState(state) {
        if (!state) return;
        if (state.mode === 'welcome') {
            setMode('welcome');
            return;
        }
        if (state.mode === 'cart') {
            setMode('cart');
            renderCart(state.cart || null);
            return;
        }
        if (state.mode === 'invoice') {
            setMode('invoice');
            renderInvoice(state.invoice || {});
            return;
        }
        setMode('welcome');
    }

    ensureChannel();
</script>
</body>
</html>
