<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Kundendisplay – Sandersdorfer Karnevalsverein e.V.</title>
    <style>
        :root {
            --bg: #0f172a;
            --royal-blue: #4169E1;
            --panel-bg: #ffffff;
            --muted: #64748b;
            --accent: #f97316;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "Segoe UI", system-ui, sans-serif;
            background: radial-gradient(circle at top, rgba(65,105,225,0.12), rgba(15,23,42,0.95));
            color: #0f172a;
        }

        .display-app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 32px 24px 48px;
            gap: 32px;
        }

        .display-header {
            text-align: center;
            color: #fff;
        }

        .display-header h1 {
            margin: 0;
            font-size: clamp(28px, 4vw, 42px);
            letter-spacing: 1.2px;
        }

        .display-header p {
            margin: 8px 0 0;
            font-size: clamp(18px, 2.5vw, 24px);
            opacity: 0.85;
        }

        .display-main {
            width: min(1200px, 95vw);
            flex: 1;
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
            align-items: stretch;
            justify-items: center;
        }

        .plan-frame {
            width: 100%;
            border: 0;
            border-radius: 18px;
            box-shadow: 0 25px 60px rgba(15, 23, 42, 0.35);
            min-height: 640px;
        }

        .invoice-view {
            width: 100%;
            display: flex;
            justify-content: center;
        }

        .invoice-card {
            width: min(900px, 95%);
            background: var(--panel-bg);
            border-radius: 24px;
            padding: 32px;
            box-shadow: 0 25px 80px rgba(15, 23, 42, 0.3);
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .invoice-card h2 {
            margin: 0;
            font-size: clamp(26px, 3vw, 32px);
            color: var(--royal-blue);
        }

        .invoice-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 16px 32px;
            font-size: 16px;
            color: var(--muted);
        }

        .invoice-meta strong {
            color: #0f172a;
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            border-spacing: 0;
        }

        .invoice-table thead th {
            text-align: left;
            font-weight: 600;
            padding-bottom: 8px;
            border-bottom: 2px solid rgba(99, 102, 241, 0.15);
            font-size: 14px;
            color: var(--muted);
        }

        .invoice-table tbody td {
            padding: 12px 0;
            border-bottom: 1px solid rgba(148, 163, 184, 0.25);
        }

        .invoice-table tbody tr:last-child td {
            border-bottom: 0;
        }

        .invoice-line-name {
            font-weight: 600;
            color: #0f172a;
        }

        .invoice-line-detail {
            color: var(--muted);
            font-size: 13px;
        }

        .invoice-summary {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 24px;
            align-items: center;
        }

        .invoice-total {
            font-size: clamp(26px, 4vw, 32px);
            font-weight: 700;
            color: #0f172a;
        }

        .invoice-payment {
            font-size: 16px;
            color: var(--muted);
        }

        .invoice-note {
            margin: 0;
            font-size: 14px;
            color: var(--muted);
        }

        .invoice-qr {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .invoice-qr img {
            width: clamp(220px, 30vw, 280px);
            height: clamp(220px, 30vw, 280px);
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(15, 23, 42, 0.25);
            background: #fff;
            object-fit: cover;
        }

        .invoice-download {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 18px;
            border-radius: 999px;
            border: 0;
            background: var(--royal-blue);
            color: #fff;
            font-weight: 600;
            font-size: 15px;
            text-decoration: none;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .invoice-download:hover,
        .invoice-download:focus {
            transform: translateY(-2px);
            box-shadow: 0 18px 36px rgba(65, 105, 225, 0.35);
        }

        .invoice-placeholder {
            text-align: center;
            font-size: clamp(22px, 3vw, 28px);
            color: #fff;
            opacity: 0.85;
            margin-top: 120px;
        }
    </style>
</head>
<body>
<div class="display-app">
    <header class="display-header">
        <h1>Sandersdorfer Karnevalsverein e. V.</h1>
        <p>Kundendisplay</p>
    </header>
    <main class="display-main">
        <iframe id="plan-frame" class="plan-frame" src="saalplan_extern.html" title="Saalplan" loading="lazy"></iframe>
        <section id="invoice-view" class="invoice-view" hidden>
            <article class="invoice-card">
                <header>
                    <h2 id="invoice-title">Rechnungsübersicht</h2>
                    <div class="invoice-meta" id="invoice-meta"></div>
                </header>
                <div class="invoice-content" id="invoice-content">
                    <table class="invoice-table" aria-describedby="invoice-title">
                        <thead>
                        <tr>
                            <th scope="col">Position</th>
                            <th scope="col" style="width:100px; text-align:right;">Karten</th>
                            <th scope="col" style="width:140px; text-align:right;">Einzelpreis</th>
                            <th scope="col" style="width:160px; text-align:right;">Gesamt</th>
                        </tr>
                        </thead>
                        <tbody id="invoice-lines"></tbody>
                    </table>
                </div>
                <div class="invoice-summary">
                    <div>
                        <div class="invoice-total" id="invoice-total">&mdash;</div>
                        <div class="invoice-payment" id="invoice-payment">&nbsp;</div>
                        <p class="invoice-note">Die Rechnung gilt nicht als Eintrittskarte.</p>
                    </div>
                    <div class="invoice-qr" id="invoice-qr" hidden>
                        <img id="invoice-qr-image" src="" alt="QR-Code zum Rechnungsdownload" />
                        <a id="invoice-download" class="invoice-download" href="#" download>Rechnung herunterladen</a>
                    </div>
                </div>
            </article>
        </section>
        <div id="invoice-placeholder" class="invoice-placeholder" hidden>
            Kundendisplay wartet auf neue Bestellung …
        </div>
    </main>
</div>
<script>
    const CHANNEL_NAME = "skv-customer-display";
    const STORAGE_KEY = "skv-customer-display-message";
    const MESSAGE_MARKER = "__skvCustomerDisplay";
    const euroFormatter = new Intl.NumberFormat('de-DE', {
        style: 'currency',
        currency: 'EUR',
        minimumFractionDigits: 2,
    });

    const planFrame = document.getElementById('plan-frame');
    const invoiceView = document.getElementById('invoice-view');
    const invoiceMeta = document.getElementById('invoice-meta');
    const invoiceLines = document.getElementById('invoice-lines');
    const invoiceTotal = document.getElementById('invoice-total');
    const invoicePayment = document.getElementById('invoice-payment');
    const invoiceQr = document.getElementById('invoice-qr');
    const invoiceQrImage = document.getElementById('invoice-qr-image');
    const invoiceDownload = document.getElementById('invoice-download');
    const placeholder = document.getElementById('invoice-placeholder');

    let channel = null;
    let storageListenerBound = false;

    function ensureChannel() {
        if (typeof BroadcastChannel !== 'undefined') {
            if (!channel) {
                channel = new BroadcastChannel(CHANNEL_NAME);
                channel.addEventListener('message', onChannelMessage);
            }
        }
        if (!storageListenerBound && typeof window !== 'undefined') {
            window.addEventListener('storage', onStorageMessage);
            storageListenerBound = true;
        }
    }

    function handleEnvelope(envelope) {
        if (!envelope || envelope.marker !== MESSAGE_MARKER) return;
        const data = envelope.data;
        if (data?.type === 'state' && data.payload) {
            applyState(data.payload);
        }
    }

    function onChannelMessage(event) {
        handleEnvelope(event?.data);
    }

    function onStorageMessage(event) {
        if (!event || event.key !== STORAGE_KEY || !event.newValue) return;
        try {
            const parsed = JSON.parse(event.newValue);
            handleEnvelope(parsed);
        } catch (err) {
            console.warn('[KUNDENDISPLAY] Nachricht aus localStorage konnte nicht gelesen werden:', err);
        }
    }

    function setMode(mode) {
        if (mode === 'plan') {
            planFrame.hidden = false;
            invoiceView.hidden = true;
            placeholder.hidden = true;
        } else if (mode === 'cart' || mode === 'invoice') {
            planFrame.hidden = true;
            invoiceView.hidden = false;
            placeholder.hidden = true;
        } else {
            planFrame.hidden = true;
            invoiceView.hidden = true;
            placeholder.hidden = false;
        }
    }

    function renderCart(cart) {
        invoiceMeta.innerHTML = '';
        invoiceLines.innerHTML = '';
        invoiceQr.hidden = true;
        invoiceTotal.textContent = cart ? euroFormatter.format(cart.totalAmount || 0) : '—';
        invoicePayment.textContent = cart ? `${cart.totalCards || 0} Karten im Warenkorb` : '';
        if (!cart || !Array.isArray(cart.lines) || cart.lines.length === 0) {
            invoiceLines.innerHTML = '<tr><td colspan="4">Keine Positionen vorhanden.</td></tr>';
            return;
        }
        for (const line of cart.lines) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <div class="invoice-line-name">${line.name || 'Position'}</div>
                    ${line.detail ? `<div class="invoice-line-detail">${line.detail}</div>` : ''}
                </td>
                <td style="text-align:right; font-weight:600;">${line.quantity}</td>
                <td style="text-align:right;">${line.unitPriceFormatted || ''}</td>
                <td style="text-align:right; font-weight:600;">${line.totalFormatted || ''}</td>
            `;
            invoiceLines.appendChild(tr);
        }
    }

    function renderInvoice(invoice) {
        invoiceMeta.innerHTML = '';
        const metaParts = [];
        if (invoice.invoiceNumber) metaParts.push(`<strong>Rechnungsnummer:</strong> ${invoice.invoiceNumber}`);
        if (invoice.createdAt) {
            const date = new Date(invoice.createdAt);
            if (!Number.isNaN(date.valueOf())) {
                metaParts.push(`<strong>Datum:</strong> ${date.toLocaleDateString('de-DE')} ${date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })}`);
            }
        }
        if (metaParts.length) {
            invoiceMeta.innerHTML = metaParts.join('<span aria-hidden="true">•</span>');
        }
        renderCart(invoice);
        invoicePayment.textContent = invoice.paymentLabel ? `Zahlart: ${invoice.paymentLabel}` : '';
        invoiceTotal.textContent = euroFormatter.format(invoice.totalAmount || 0);
        if (invoice.dataUrl) {
            invoiceDownload.href = invoice.dataUrl;
            invoiceDownload.download = invoice.fileName || 'Rechnung.pdf';
        }
        if (invoice.shareUrl || invoice.shareToken) {
            const href = invoice.shareUrl || buildShareUrl(invoice.shareToken);
            invoiceQr.hidden = false;
            invoiceQrImage.src = buildQrSrc(href);
            invoiceQrImage.alt = 'QR-Code zur Rechnung';
            invoiceQrImage.onerror = () => {
                invoiceQrImage.alt = 'QR-Code konnte nicht geladen werden';
            };
        } else {
            invoiceQr.hidden = true;
        }
    }

    function buildShareUrl(token) {
        const base = new URL(window.location.href);
        base.hash = '';
        base.search = '';
        base.pathname = base.pathname.replace(/[^/]+$/, 'invoice.html');
        return `${base.href.replace(/#.*$/, '')}#${token}`;
    }

    function buildQrSrc(url) {
        const base = 'https://api.qrserver.com/v1/create-qr-code/';
        const params = new URLSearchParams({
            size: '320x320',
            data: url,
        });
        return `${base}?${params.toString()}`;
    }

    function applyState(state) {
        if (!state) return;
        if (state.mode === 'plan') {
            setMode('plan');
            return;
        }
        if (state.mode === 'cart') {
            setMode('cart');
            renderCart(state.cart || null);
            return;
        }
        if (state.mode === 'invoice') {
            setMode('invoice');
            renderInvoice(state.invoice || {});
            return;
        }
        setMode('idle');
    }

    ensureChannel();
</script>
</body>
</html>
