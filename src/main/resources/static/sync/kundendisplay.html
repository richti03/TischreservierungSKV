<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="icon" href="../img/SKV-Wappen.png">
    <title>Kundendisplay – Sandersdorfer Karnevalsverein e.V.</title>
    <style>
        :root {
            --skv-blue: #4169E1;
            --skv-blue-dark: #1f3f94;
            --skv-text: #1f2937;
            --skv-muted: #64748b;
            --skv-border: #d9e2f1;
            --skv-background: #f3f6ff;
            --skv-card-shadow: rgba(15, 23, 42, 0.12);
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: "Segoe UI", "Arial", sans-serif;
            background: var(--skv-background);
            color: var(--skv-text);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: clamp(16px, 4vw, 32px);
        }

        .display-wrapper {
            width: min(960px, 96vw);
            display: flex;
            flex-direction: column;
            gap: clamp(20px, 3vw, 28px);
        }

        .display-header {
            background: var(--skv-blue);
            border-radius: 16px;
            color: #fff;
            padding: clamp(18px, 3vw, 28px);
            display: flex;
            align-items: center;
            gap: clamp(18px, 3vw, 32px);
            box-shadow: 0 18px 36px rgba(31, 63, 148, 0.25);
        }

        .display-header__logo {
            width: clamp(82px, 14vw, 110px);
            height: clamp(82px, 14vw, 110px);
            border-radius: 12px;
            object-fit: cover;
            background: #fff;
            box-shadow: 0 8px 18px rgba(255, 255, 255, 0.18);
        }

        .display-header__text h1 {
            margin: 0;
            font-size: clamp(24px, 4vw, 32px);
            font-weight: 600;
        }

        .display-header__text p {
            margin: 6px 0 0;
            font-size: clamp(15px, 2.4vw, 18px);
            color: rgba(255, 255, 255, 0.85);
        }

        .display-main {
            display: flex;
            flex-direction: column;
            gap: clamp(16px, 3vw, 24px);
        }

        .display-card {
            background: #fff;
            border-radius: 14px;
            padding: clamp(20px, 3vw, 32px);
            box-shadow: 0 14px 32px var(--skv-card-shadow);
        }

        .display-card h2 {
            margin: 0 0 16px;
            font-size: clamp(20px, 3.2vw, 26px);
            color: var(--skv-blue-dark);
        }

        .welcome-text {
            margin: 0;
            font-size: clamp(16px, 2.6vw, 20px);
            color: var(--skv-muted);
            text-align: center;
        }

        .cart-table {
            width: 100%;
            border-collapse: collapse;
            font-size: clamp(14px, 2.4vw, 16px);
        }

        .cart-table thead th {
            text-align: left;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--skv-border);
            font-size: 12px;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--skv-muted);
        }

        .cart-table tbody td {
            padding: 10px 0;
            border-bottom: 1px solid var(--skv-border);
            vertical-align: top;
        }

        .cart-table tbody tr:last-child td {
            border-bottom: none;
        }

        .cart-line-name {
            font-weight: 600;
            color: var(--skv-text);
        }

        .cart-line-detail {
            margin-top: 4px;
            color: var(--skv-muted);
            font-size: 12px;
        }

        .cart-summary {
            margin-top: 18px;
            padding-top: 16px;
            border-top: 1px solid var(--skv-border);
            display: flex;
            flex-wrap: wrap;
            gap: 16px 24px;
        }

        .cart-summary__item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .cart-summary__label {
            font-size: 12px;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--skv-muted);
        }

        .cart-summary__value {
            font-size: clamp(18px, 3vw, 24px);
            font-weight: 600;
            color: var(--skv-blue-dark);
        }

        .cart-note {
            margin: 18px 0 0;
            font-size: 13px;
            color: var(--skv-muted);
        }

        #invoice-view {
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, #4169E1, #1f3f94);
            color: #fff;
            box-shadow: 0 20px 42px rgba(31, 63, 148, 0.35);
        }

        .invoice-thanks-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 18px;
            position: relative;
            z-index: 1;
            text-align: center;
        }

        .invoice-thanks {
            text-align: center;
            font-size: clamp(32px, 6vw, 54px);
            letter-spacing: 0.18em;
            color: #fff;
            text-transform: uppercase;
            text-shadow: 0 12px 28px rgba(31, 63, 148, 0.35);
            margin: 0;
        }

        .invoice-subtitle {
            margin: 0;
            font-size: clamp(20px, 3vw, 30px);
            color: rgba(255, 255, 255, 0.95);
            letter-spacing: 0.14em;
            text-transform: uppercase;
        }

        .confetti {
            position: absolute;
            inset: 0;
            overflow: hidden;
            pointer-events: none;
        }

        .confetti-piece {
            position: absolute;
            top: -12%;
            width: 12px;
            height: 24px;
            border-radius: 4px;
            background: var(--color, #f6c90e);
            opacity: 0;
            left: calc(var(--x, 0.5) * 100%);
            transform: rotate(var(--rotation, 0deg));
            animation-duration: calc(var(--duration, 5) * 1s);
            animation-delay: calc(var(--delay, 0) * 1s);
            animation-timing-function: linear;
            animation-iteration-count: infinite;
            animation-name: none;
        }

        .confetti.active .confetti-piece {
            animation-name: confetti-fall;
        }

        @keyframes confetti-fall {
            0% {
                transform: translate3d(0, -120%, 0) rotate(var(--rotation, 0deg));
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            100% {
                transform: translate3d(var(--drift, 0px), 120vh, 0) rotate(calc(var(--rotation, 0deg) + 360deg));
                opacity: 0;
            }
        }

        [hidden] {
            display: none !important;
        }

        @media (max-width: 640px) {
            .display-header {
                flex-direction: column;
                text-align: center;
            }

            .display-header__logo {
                width: 96px;
                height: 96px;
            }

            .invoice-thanks {
                letter-spacing: 0.14em;
            }

            .invoice-subtitle {
                font-size: clamp(18px, 4vw, 24px);
            }
        }
    </style>
</head>
<body>
<div class="display-wrapper">
    <header class="display-header">
        <img src="../img/SKV-Wappen.png" alt="Logo des Sandersdorfer Karnevalsverein" class="display-header__logo"/>
        <div class="display-header__text">
            <h1>Herzlich willkommen beim Sandersdorfer Karnevalsverein</h1>
            <p id="display-subtitle">Schön, dass Sie da sind – gleich sehen Sie Ihre Reservierung im Überblick.</p>
        </div>
    </header>
    <main id="display-main" class="display-main">
        <section id="welcome-view" class="display-card">
            <p class="welcome-text">Sobald Reservierungen ausgewählt sind, erscheinen sie hier.</p>
        </section>
        <section id="cart-view" class="display-card" hidden>
            <h2>Ihre Reservierungen</h2>
            <table class="cart-table" aria-describedby="display-subtitle">
                <thead>
                <tr>
                    <th scope="col">Position</th>
                    <th scope="col" style="width:100px; text-align:right;">Karten</th>
                    <th scope="col" style="width:140px; text-align:right;">Einzelpreis</th>
                    <th scope="col" style="width:150px; text-align:right;">Gesamt</th>
                </tr>
                </thead>
                <tbody id="cart-lines"></tbody>
            </table>
            <div class="cart-summary">
                <div class="cart-summary__item">
                    <span class="cart-summary__label">Gesamtbetrag</span>
                    <span class="cart-summary__value" id="cart-total">—</span>
                </div>
                <div class="cart-summary__item">
                    <span class="cart-summary__label">Karten</span>
                    <span class="cart-summary__value" id="cart-count">—</span>
                </div>
            </div>
            <p class="cart-note">Die Rechnung gilt nicht als Eintrittskarte.</p>
        </section>
        <section id="invoice-view" class="display-card" hidden>
            <div class="invoice-thanks-wrapper">
                <h2 class="invoice-thanks">DANKE!</h2>
                <p class="invoice-subtitle">SANDORIA HELLAU!</p>
            </div>
            <div class="confetti" id="invoice-confetti" aria-hidden="true"></div>
        </section>
    </main>
</div>
<script>
    const CHANNEL_NAME = "skv-customer-display";
    const STORAGE_KEY = "skv-customer-display-message";
    const MESSAGE_MARKER = "__skvCustomerDisplay";
    const euroFormatter = new Intl.NumberFormat('de-DE', {
        style: 'currency',
        currency: 'EUR',
        minimumFractionDigits: 2,
    });

    const displaySubtitle = document.getElementById('display-subtitle');
    const welcomeView = document.getElementById('welcome-view');
    const cartView = document.getElementById('cart-view');
    const invoiceView = document.getElementById('invoice-view');
    const cartLines = document.getElementById('cart-lines');
    const cartTotal = document.getElementById('cart-total');
    const cartCount = document.getElementById('cart-count');
    const invoiceConfetti = document.getElementById('invoice-confetti');

    let channel;
    let currentMode = 'welcome';

    function createConfettiPieces(count = 28) {
        if (!invoiceConfetti) return;
        invoiceConfetti.innerHTML = '';
        const colors = ['#f6c90e', '#f08a5d', '#b83b5e', '#6a2c70', '#28c76f', '#00c2ff'];
        for (let i = 0; i < count; i += 1) {
            const span = document.createElement('span');
            span.className = 'confetti-piece';
            span.style.setProperty('--x', Math.random().toFixed(2));
            span.style.setProperty('--delay', (Math.random() * 2.5).toFixed(2));
            span.style.setProperty('--duration', (4 + Math.random() * 3).toFixed(2));
            span.style.setProperty('--rotation', `${Math.floor(Math.random() * 360)}deg`);
            span.style.setProperty('--drift', `${(Math.random() * 50 - 25).toFixed(2)}px`);
            span.style.setProperty('--color', colors[i % colors.length]);
            invoiceConfetti.appendChild(span);
        }
    }

    function triggerConfetti() {
        if (!invoiceConfetti) return;
        invoiceConfetti.classList.remove('active');
        void invoiceConfetti.offsetWidth; // restart animation
        invoiceConfetti.classList.add('active');
    }

    function ensureChannel() {
        if (channel || typeof BroadcastChannel === 'undefined') {
            return channel;
        }
        try {
            channel = new BroadcastChannel(CHANNEL_NAME);
            channel.addEventListener('message', handleIncomingMessage);
        } catch (err) {
            console.warn('[KUNDENDISPLAY] BroadcastChannel konnte nicht erstellt werden:', err);
            channel = null;
        }
        if (typeof window !== 'undefined') {
            window.addEventListener('beforeunload', () => {
                try {
                    channel?.close();
                } catch (err) {
                    console.warn('[KUNDENDISPLAY] BroadcastChannel konnte nicht geschlossen werden:', err);
                }
            }, { once: true });
            window.addEventListener('storage', onStorageMessage);
        }
        return channel;
    }

    function initFromStorage() {
        if (typeof localStorage === 'undefined' || localStorage === null) return;
        try {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (!stored) return;
            const parsed = JSON.parse(stored);
            handleEnvelope(parsed);
        } catch (err) {
            console.warn('[KUNDENDISPLAY] Vorherigen Zustand konnte nicht geladen werden:', err);
        }
    }

    function handleIncomingMessage(event) {
        const envelope = event?.data;
        handleEnvelope(envelope);
    }

    function onStorageMessage(event) {
        if (!event || event.key !== STORAGE_KEY || !event.newValue) return;
        try {
            const parsed = JSON.parse(event.newValue);
            handleEnvelope(parsed);
        } catch (err) {
            console.warn('[KUNDENDISPLAY] Nachricht aus localStorage konnte nicht gelesen werden:', err);
        }
    }

    function handleEnvelope(envelope) {
        if (!envelope || envelope.marker !== MESSAGE_MARKER) return;
        const payload = envelope.data?.payload;
        if (!payload) return;
        applyState(payload);
    }

    function setMode(mode) {
        if (currentMode === mode) return;
        currentMode = mode;
        if (mode === 'welcome') {
            welcomeView.hidden = false;
            cartView.hidden = true;
            invoiceView.hidden = true;
            if (displaySubtitle) {
                displaySubtitle.textContent = 'Schön, dass Sie da sind – gleich sehen Sie Ihre Reservierung im Überblick.';
            }
        } else if (mode === 'cart') {
            welcomeView.hidden = true;
            cartView.hidden = false;
            invoiceView.hidden = true;
            if (displaySubtitle) {
                displaySubtitle.textContent = 'Bitte prüfen Sie Ihre Reservierungen.';
            }
        } else if (mode === 'invoice') {
            welcomeView.hidden = true;
            cartView.hidden = true;
            invoiceView.hidden = false;
            if (displaySubtitle) {
                displaySubtitle.textContent = 'SANDORIA HELLAU!';
            }
            createConfettiPieces();
            triggerConfetti();
        }
    }

    function renderCart(cart) {
        cartLines.innerHTML = '';
        const totalAmount = Number.isFinite(cart?.totalAmount) ? cart.totalAmount : null;
        cartTotal.textContent = totalAmount != null ? euroFormatter.format(totalAmount) : '—';
        const cards = Number.isFinite(cart?.totalCards) ? cart.totalCards : null;
        if (cards != null) {
            cartCount.textContent = cards === 1 ? '1 Karte' : `${cards} Karten`;
        } else {
            cartCount.textContent = '—';
        }

        if (!cart || !Array.isArray(cart.lines) || cart.lines.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="4">Aktuell sind keine Reservierungen ausgewählt.</td>';
            cartLines.appendChild(row);
            return;
        }

        cart.lines.forEach(line => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <div class="cart-line-name">${line.name || 'Position'}</div>
                    ${line.detail ? `<div class="cart-line-detail">${line.detail}</div>` : ''}
                </td>
                <td style="text-align:right; font-weight:600;">${line.quantity ?? ''}</td>
                <td style="text-align:right;">${line.unitPriceFormatted || ''}</td>
                <td style="text-align:right; font-weight:600;">${line.totalFormatted || ''}</td>
            `;
            cartLines.appendChild(tr);
        });
    }

    function applyState(state) {
        if (!state) return;
        if (state.mode === 'welcome') {
            setMode('welcome');
            return;
        }
        if (state.mode === 'cart') {
            renderCart(state.cart || null);
            setMode('cart');
            return;
        }
        if (state.mode === 'invoice') {
            setMode('invoice');
            return;
        }
        setMode('welcome');
    }

    ensureChannel();
    initFromStorage();
    createConfettiPieces();
</script>
</body>
</html>
